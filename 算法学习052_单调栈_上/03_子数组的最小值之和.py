from typing import List

"""
================================================================================
ğŸ“˜ é¢˜ç›®æè¿° : 907. å­æ•°ç»„çš„æœ€å°å€¼ä¹‹å’Œ (Sum of Subarray Minimums)
#### æµ‹è¯•é“¾æ¥: https://leetcode.cn/problems/sum-of-subarray-minimums/
================================================================================
ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ arr,æ‰¾åˆ° min(b) çš„æ€»å’Œ,å…¶ä¸­ b çš„èŒƒå›´ä¸º arr çš„æ¯ä¸ª(è¿ç»­)å­æ•°ç»„.
ç”±äºç­”æ¡ˆå¯èƒ½å¾ˆå¤§,å› æ­¤ è¿”å›ç­”æ¡ˆæ¨¡ 10^9 + 7 .

ğŸŒŸ ç¤ºä¾‹ 1:
   è¾“å…¥:arr = [3,1,2,4]
   è¾“å‡º:17
   è§£é‡Š:
   å­æ•°ç»„ä¸º [3], [1], [2], [4], [3,1], [1,2], [2,4], [3,1,2], [1,2,4], [3,1,2,4]ã€‚
   æœ€å°å€¼ä¸º 3, 1, 2, 4, 1, 1, 2, 1, 1, 1 , å’Œä¸º 17.

ğŸ“ æç¤º:
   1 <= arr.length <= 3 * 10^4
   1 <= arr[i] <= 3 * 10^4
================================================================================
"""

class Solution:
    MOD = 1000000007 
    # âš¡ é¢„åˆ†é…å†…å­˜,æ¨¡æ‹Ÿæ ˆ.stack å­˜çš„æ˜¯ä¸‹æ ‡
    stack: list[int] = [0] * 30001
    r = 0

    def sumSubarrayMins(self, arr: List[int]) -> int:
        n: int = len(arr)
        self.r = 0 # ğŸ”„ åˆå§‹åŒ–æ ˆé¡¶æŒ‡é’ˆ
        ans = 0
        
        # ğŸŸ¢ éå†æ•°ç»„:ç»´æŠ¤ä¸€ä¸ªå•è°ƒé€’å¢æ ˆ
        # æ ¸å¿ƒæ€æƒ³: æ‰¾åˆ°ä»¥ arr[cur] ä¸ºæœ€å°å€¼çš„å­æ•°ç»„èŒƒå›´ (left, i)
        for i in range(n):
            # å¼€å¤´çš„å¯èƒ½æ€§: cur - left (å·¦è¾¹èƒ½å»¶ä¼¸å¤šè¿œ)
            # ç»“å°¾çš„å¯èƒ½æ€§: i - cur    (å³è¾¹èƒ½å»¶ä¼¸å¤šè¿œ)
            
            # è¿™é‡Œçš„å«ä¹‰æ˜¯ï¼šå½“æ ˆé¡¶å…ƒç´  >= å½“å‰å…ƒç´  arr[i] æ—¶,è¯´æ˜æ ˆé¡¶å…ƒç´ çš„å³è¾¹ç•Œç¡®å®šäº†
            while self.r > 0 and arr[self.stack[self.r-1]] >= arr[i]:
                # 1ï¸âƒ£ å¼¹å‡ºæ ˆé¡¶ä¸‹æ ‡,ä½œä¸ºå½“å‰è®¡ç®—ä¸­å¿ƒ
                cur: int = self.stack[self.r-1]
                self.r -= 1
                
                # 2ï¸âƒ£ æ‰¾å·¦è¾¹ç•Œ left
                # å¦‚æœæ ˆç©ºäº†,è¯´æ˜ cur å·¦è¾¹æ²¡æœ‰æ¯”å®ƒå°çš„,è¾¹ç•Œä¸º -1
                # å¦åˆ™,æ–°æ ˆé¡¶å°±æ˜¯ cur å·¦è¾¹ç¬¬ä¸€ä¸ªæ¯”å®ƒå°çš„æ•°
                left: int = -1 if self.r == 0 else self.stack[self.r-1]
                
                # 3ï¸âƒ£ ç´¯åŠ è´¡çŒ®å€¼
                # è´¡çŒ® = å€¼ * å·¦è¾¹æ•°é‡ * å³è¾¹æ•°é‡
                ans = (ans + (cur - left) * (i - cur) * arr[cur]) % self.MOD
            
            # â¡ï¸ å½“å‰ä¸‹æ ‡å…¥æ ˆ
            self.stack[self.r] = i
            self.r += 1

        # ğŸŸ¡ å¾ªç¯ç»“æŸå,å¤„ç†æ ˆä¸­å‰©ä½™å…ƒç´ 
        # è¿™äº›å…ƒç´ å³è¾¹æ²¡æœ‰æ›´å°çš„æ•°äº†,æ‰€ä»¥å³è¾¹ç•Œå»¶ä¼¸åˆ° n(ç´¢å¼•ä¸ºn)
        while self.r > 0:
            cur: int = self.stack[self.r-1]
            self.r -= 1
            
            left: int = -1 if self.r == 0 else self.stack[self.r-1]
            
            # å³è¾¹ç•Œè§†ä¸º n
            ans = (ans + (cur - left) * (n - cur) * arr[cur]) % self.MOD
            
        return ans